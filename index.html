<!DOCTYPE html>
<html lang="fr">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="üîéDrone Tool">
    <meta charset="UTF-8">
    <link rel="apple-touch-icon" href="icon.png">

    <title>üîéDrone FiltreND</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;600;700&family=Inconsolata:wght@400;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0e1a;
            --bg-secondary: #111827;
            --bg-card: #1a2332;
            --accent-green: #10b981;
            --accent-orange: #f59e0b;
            --accent-red: #ef4444;
            --accent-cyan: #06b6d4;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --border-color: #2d3748;
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(6, 182, 212, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(16, 185, 129, 0.06) 0%, transparent 50%);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 40px 20px;
            border-bottom: 2px solid var(--border-color);
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
            margin-bottom: 40px;
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(6, 182, 212, 0.03) 10px,
                rgba(6, 182, 212, 0.03) 20px
            );
            animation: slide 20s linear infinite;
        }

        @keyframes slide {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }

        h1 {
            font-size: 3.5rem;
            font-weight: 700;
            letter-spacing: -1px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            position: relative;
            z-index: 1;
        }

        .subtitle {
            font-size: 1.2rem;
            color: var(--text-secondary);
            font-weight: 300;
            position: relative;
            z-index: 1;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-green));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-cyan);
            box-shadow: 0 10px 30px rgba(6, 182, 212, 0.2);
        }

        .card:hover::before {
            transform: scaleX(1);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--accent-cyan);
            font-family: 'Inconsolata', monospace;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-green { background: var(--accent-green); box-shadow: 0 0 10px var(--accent-green); }
        .status-orange { background: var(--accent-orange); box-shadow: 0 0 10px var(--accent-orange); }
        .status-red { background: var(--accent-red); box-shadow: 0 0 10px var(--accent-red); }

        .location-input {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        input, select {
            flex: 1;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Rajdhani', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        }

        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-green));
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            font-family: 'Rajdhani', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(6, 182, 212, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .weather-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .weather-item {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .weather-value .unit {
            font-size: 0.75em;
            opacity: 0.7;
        }

        .weather-item .subtext {
            font-size: 1rem;
            opacity: 0.7;
            margin-top: 4px;
        }


        .weather-item.safe {
            border-left-color: var(--accent-green);
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.1), var(--bg-secondary));
        }

        .weather-item.warning {
            border-left-color: var(--accent-orange);
            background: linear-gradient(90deg, rgba(245, 158, 11, 0.1), var(--bg-secondary));
        }

        .weather-item.danger {
            border-left-color: var(--accent-red);
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.1), var(--bg-secondary));
        }

        .weather-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
            font-family: 'Inconsolata', monospace;
        }

        .weather-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .overall-status {
            margin-top: 20px;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            font-size: 1.3rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .overall-status.safe {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1));
            color: var(--accent-green);
            border: 2px solid var(--accent-green);
        }

        .overall-status.warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1));
            color: var(--accent-orange);
            border: 2px solid var(--accent-orange);
        }

        .overall-status.danger {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));
            color: var(--accent-red);
            border: 2px solid var(--accent-red);
        }

        .filter-calculator {
            display: grid;
            gap: 15px;
        }

        .filter-result {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid var(--accent-cyan);
            margin-top: 20px;
        }

        .filter-recommendation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: linear-gradient(90deg, rgba(6, 182, 212, 0.1), transparent);
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid var(--accent-cyan);
        }

        .filter-recommendation:last-child {
            margin-bottom: 0;
        }

        .filter-name {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--accent-cyan);
        }

        .filter-details {
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .shutter-speed {
            font-size: 1.1rem;
            font-weight: 600;
            font-family: 'Inconsolata', monospace;
            color: var(--accent-green);
        }

        #map {
            height: 500px;
            border-radius: 12px;
            border: 2px solid var(--border-color);
        }

        .map-card {
            grid-column: 1 / -1;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
            font-style: italic;
        }

        .info-badge {
            display: inline-block;
            padding: 4px 12px;
            background: rgba(6, 182, 212, 0.2);
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--accent-cyan);
            margin-left: 10px;
            font-family: 'Inconsolata', monospace;
        }

/* RESPONSIVE - MODE T√âL√âPHONE */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            header {
                padding: 25px 15px;
                margin-bottom: 20px;
            }

            h1 {
                font-size: 2rem;
            }

            .subtitle {
                font-size: 1rem;
            }

            .grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .card {
                padding: 18px;
            }

            .card-title {
                font-size: 1.2rem;
            }

            .weather-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .weather-item {
                padding: 12px;
            }

            .weather-value {
                font-size: 1.5rem;
            }

            .location-input {
                flex-direction: column;
            }

            .location-input input {
                width: 100%;
            }

            .location-input button {
                width: 100%;
                padding: 14px;
            }

            .filter-calculator select,
            .filter-calculator input,
            .filter-calculator button {
                font-size: 1rem;
                padding: 14px;
            }

            #map {
                height: 350px;
            }

            .filter-recommendation {
                flex-direction: column;
                gap: 10px;
            }

            .overall-status {
                font-size: 1.1rem;
                padding: 15px;
            }
        }

        /* MODE TR√àS PETIT T√âL√âPHONE */
        @media (max-width: 480px) {
            h1 {
                font-size: 1.8rem;
            }

            .subtitle {
                font-size: 0.9rem;
            }

            .card {
                padding: 15px;
            }

            .weather-value {
                font-size: 1.3rem;
            }

            .unit {
                font-size: 0.9rem;
            }

            #map {
                height: 300px;
            }

            button {
                padding: 12px 20px;
                font-size: 0.9rem;
            }
        }

        /* MODE PAYSAGE T√âL√âPHONE */
        @media (max-width: 900px) and (orientation: landscape) {
            header {
                padding: 20px 15px;
            }

            h1 {
                font-size: 2rem;
            }

            .grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .map-card {
                grid-column: 1 / -1;
            }

            #map {
                height: 300px;
            }
        }
        
        .info-box {
            background: rgba(245, 158, 11, 0.1);
            border-left: 4px solid var(--accent-orange);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .info-box h4 {
            color: var(--accent-orange);
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .info-box p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.6;
        }

        /* ===== VERSION AM√âLIOR√âE LOCATION INPUT ===== */

        .location-input.enhanced {
            display: flex;
            flex-direction: column;
            gap: 14px;
            margin-bottom: 25px;
        }

        /* Bouton principal GPS */
        .btn-location-main {
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-green));
            border: none;
            padding: 14px;
            border-radius: 10px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: white;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.4);
        }

        /* Effet glow anim√© */
        .btn-location-main::after {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                120deg,
                transparent,
                rgba(255,255,255,0.3),
                transparent
            );
            transition: 0.6s;
        }

        .btn-location-main:hover::after {
            left: 100%;
        }

        .btn-location-main:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 25px rgba(6, 182, 212, 0.7);
        }

        /* Groupe recherche ville */
        .city-search-group {
            display: flex;
            gap: 8px;
        }

        /* Input ville */
        .city-search-group input {
            flex: 4;
            min-width: 0;
        }

        .city-search-group .btn-search-icon {
            flex: 1;
            padding: 0;
        }

        .btn-search-icon {
            text-transform: none;
            letter-spacing: 0;
            font-weight: 600;
        }


        .btn-search-icon:hover {
            border-color: var(--accent-cyan);
            box-shadow: 0 0 10px rgba(6, 182, 212, 0.3);
        }

    </style>
</head>
<body>
    <header>
        <h1>üöÅ Drone / FPV</h1>
        <p class="subtitle">Info m√©t√©o & vol, Filtre ND & Carte int√©ractive</p>
    </header>

    <div class="container">
        <div class="grid">
            <!-- M√©t√©o Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">CONDITIONS M√âT√âO</h2>
                    <div class="status-indicator" id="weatherStatus"></div>
                </div>


                <div class="location-input enhanced">
                    <button class="btn-location-main" onclick="getWeatherByLocation()">
                        üì° UTILISER MA POSITION
                    </button>

                    <div class="city-search-group">
                        <input type="text" id="cityInput" placeholder="Entrer une ville">
                        <button class="btn-search-icon" onclick="getWeatherByCity()">
                            üîçRecherche
                        </button>
                    </div>
                </div>

                <div id="weatherData" class="loading">
                    Chargement des donn√©es m√©t√©o...
                </div>
            </div>

            <!-- ND Filter Calculator -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">CALCULATEUR FILTRE ND</h2>
                    <div class="status-indicator status-green"></div>
                </div>

                <div class="filter-calculator">
                    <!-- Mode Switch -->
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; background: var(--bg-secondary); padding: 8px; border-radius: 8px;">
                        <button id="autoModeBtn" onclick="switchMode('auto')" style="flex: 1; padding: 10px; background: linear-gradient(135deg, var(--accent-cyan), var(--accent-green)); font-size: 0.9rem;">
                            ‚ö° AUTO
                        </button>
                        <button id="manualModeBtn" onclick="switchMode('manual')" style="flex: 1; padding: 10px; background: var(--bg-card); border: 1px solid var(--border-color); font-size: 0.9rem;">
                            üéØ MANUEL
                        </button>
                    </div>

                    <select id="droneModel">
                        <option value="mini5pro">DJI Mini 5 Pro</option>
                        <option value="o3">DJI O3 Air Unit</option>
                        <option value="o4">DJI O4 Air Unit</option>
                        <option value="gopro12">GoPro Hero 12</option>
                        <option value="mini1">DJI Mavic Mini</option>
                    </select>

                    <select id="fps">
                        <option value="24">24 FPS (Cin√©matique)</option>
                        <option value="30">30 FPS (Standard)</option>
                        <option value="60">60 FPS (Smooth)</option>
                        <option value="120">120 FPS (Slow Motion)</option>
                    </select>

                    <!-- Auto Mode Fields -->
                    <div id="autoModeFields">
                        <select id="lightCondition">
                            <option value="overcast">Nuageux / Couvert</option>
                            <option value="partlyCloudy">Partiellement nuageux</option>
                            <option value="sunny">Ensoleill√©</option>
                            <option value="verySunny">Tr√®s ensoleill√© / Neige</option>
                        </select>
                    </div>

                    <!-- Manual Mode Fields -->
                    <div id="manualModeFields" style="display: none;">
                        <div style="position: relative;">
                            <input type="number" id="currentShutter" placeholder="Vitesse actuelle (ex: 2000 pour 1/2000)" min="1" step="1">
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px; font-style: italic;">
                                üí° Entrez la vitesse sans filtre affich√©e sur votre cam√©ra
                            </div>
                        </div>
                    </div>

                    <button onclick="calculateNDFilter()">Calculer le filtre</button>
                </div>

                <div id="filterResult"></div>
            </div>
        </div>

        <!-- Map Card -->
        <div class="grid">
            <div class="card map-card">
                <div class="card-header">
                    <h2 class="card-title">CARTE & RESTRICTIONS</h2>
                    <span class="info-badge">Restrictions UAS</span>
                </div>
                <div style="margin-bottom: 15px; padding: 15px; background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(16, 185, 129, 0.05)); border-radius: 10px; border-left: 4px solid var(--accent-cyan);">
                    <div style="font-size: 0.95rem; color: var(--text-primary); margin-bottom: 8px; font-weight: 600;">
                        üöÅ V√©rification des zones UAS g√©n√©ral
                        <a href="https://www.drone-spot.tech/" target="_blank" 
                        style="font-weight: 400; font-size: 1rem; color: #f59e0b; margin-left: 5px; text-decoration: underline;">
                            (Drone Spot)
                        </a>
                    </div>
                    <div style="font-size: 0.80rem; color: var(--text-secondary); line-height: 1.5;">
                        Entrez un pays pour avoir les restrictions locales
                    </div>
                </div>
                <div id="droneMapLinkContainer"></div>
                <div id="map"></div>

                <div class="info-box">
                    <h4>‚ö†Ô∏è</h4>
                    <p>
                        Nothing to Report, take care.
                    </p>
                </div>

            </div>
        </div>
    </div>

    <script>
        let map;
        let userMarker;

        // Initialisation de la carte
        function initMap(lat = 48.8566, lon = 2.3522) {
            if (!map) {
                map = L.map('map').setView([lat, lon], 13);
                
                // Couche de base OpenStreetMap
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '',
                    maxZoom: 19
                }).addTo(map);

                // Couche de restrictions UAS - WMTS du G√©oportail (TOUJOURS visible)
                L.tileLayer('https://data.geopf.fr/wmts?' +
                    'SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0' +
                    '&LAYER=TRANSPORTS.DRONES.RESTRICTIONS' +
                    '&STYLE=normal' +
                    '&FORMAT=image/png' +
                    '&TILEMATRIXSET=PM' +
                    '&TILEMATRIX={z}' +
                    '&TILEROW={y}' +
                    '&TILECOL={x}', {
                    attribution: '',
                    maxZoom: 18,
                    opacity: 0.7
                }).addTo(map);

                // Ajouter un contr√¥le d'√©chelle
                L.control.scale({
                    imperial: false,
                    metric: true
                }).addTo(map);
            } else {
                map.setView([lat, lon], 13);
            }

            if (userMarker) {
                map.removeLayer(userMarker);
            }

            userMarker = L.marker([lat, lon]).addTo(map)
                .bindPopup('üìç Votre position')
                .openPopup();
        }    

        // Recherche d'adresse
        function searchLocation() {
            const address = document.getElementById('searchAddress').value;
            if (!address) {
                alert('Veuillez entrer une adresse');
                return;
            }

            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&countrycodes=fr&limit=1`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        const lat = parseFloat(data[0].lat);
                        const lon = parseFloat(data[0].lon);
                        initMap(lat, lon);
                    } else {
                        alert('Adresse non trouv√©e');
                    }
                })
                .catch(error => {
                    console.error('Erreur de g√©ocodage:', error);
                    alert('Erreur lors de la recherche de l\'adresse');
                });
        }

        // G√©olocalisation
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        initMap(lat, lon);
                    },
                    (error) => {
                        alert('Impossible d\'obtenir votre position. V√©rifiez les autorisations de localisation.');
                    }
                );
            } else {
                alert('La g√©olocalisation n\'est pas support√©e par votre navigateur');
            }
        }

        
        // M√©t√©o par g√©olocalisation
        async function getWeatherByLocation() {
            if (!navigator.geolocation) {
                alert("La g√©olocalisation n'est pas support√©e par votre navigateur");
                return;
            }

            navigator.geolocation.getCurrentPosition(async (position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                await fetchWeatherData(lat, lon);
                initMap(lat, lon);
                fetchWeatherData(lat, lon);            }, (error) => {
                alert("Erreur de g√©olocalisation: " + error.message);
            });
        }

        // M√©t√©o par ville
        async function getWeatherByCity() {
            const city = document.getElementById('cityInput').value;
            if (!city) {
                alert("Veuillez entrer un nom de ville");
                return;
            }

            try {
                const geoResponse = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${city}&count=1&language=fr&format=json`);
                const geoData = await geoResponse.json();
                
                if (!geoData.results || geoData.results.length === 0) {
                    alert("Ville non trouv√©e");
                    return;
                }

                const lat = geoData.results[0].latitude;
                const lon = geoData.results[0].longitude;
                
                const countryCode = geoData.results[0].country_code;
                const countryName = geoData.results[0].country;

                getDroneMapByCountry(countryCode, countryName);

                fetch(`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=fr`)

                await fetchWeatherData(lat, lon);
                initMap(lat, lon);
            } catch (error) {
                console.error("Erreur:", error);
                alert("Erreur lors de la recherche de la ville");
            }
        }

        // R√©cup√©ration des donn√©es m√©t√©o
        async function fetchWeatherData(lat, lon) {
            try {
                const weatherResponse = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,precipitation,wind_speed_10m,wind_gusts_10m,visibility&daily=sunrise,sunset&timezone=auto`
                );
                const weatherData = await weatherResponse.json();

                displayWeatherData(weatherData);
            } catch (error) {
                console.error("Erreur:", error);
                document.getElementById('weatherData').innerHTML = 
                    '<p style="color: var(--accent-red);">Erreur de chargement des donn√©es m√©t√©o</p>';
            }
        }

        // Affichage des donn√©es m√©t√©o
        function displayWeatherData(data) {
            const temp = data.current.temperature_2m;
            const windSpeed = data.current.wind_speed_10m * 3.6; // Conversion en km/h
            const precipitation = data.current.precipitation;

            // D√©termination du statut pour chaque param√®tre
            const windStatus = windSpeed < 25 ? 'safe' : windSpeed < 40 ? 'warning' : 'danger';
            const rainStatus = precipitation === 0 ? 'safe' : precipitation < 2.5 ? 'warning' : 'danger';
            const tempStatus = (temp >= 5 && temp <= 35) ? 'safe' : 
                               (temp >= 0 && temp < 10) || (temp > 35 && temp <= 40) ? 'warning' : 'danger';
            const gusts = data.current.wind_gusts_10m * 3.6; // km/h
            const visibility = data.current.visibility / 1000; // km

            const sunrise = new Date(data.daily.sunrise[0]);
            const sunset = new Date(data.daily.sunset[0]);
            const now = new Date(data.current.time);


            const isDaylight = now >= sunrise && now <= sunset;

            // D√©termination du statut global
            const gustStatus =
                gusts < 30 ? 'safe' :
                gusts < 60 ? 'warning' : 'danger';

            const visibilityStatus =
                visibility >= 5 ? 'safe' :
                visibility >= 2 ? 'warning' : 'danger';

            const daylightStatus = isDaylight ? 'safe' : 'danger';
            const allStatuses = [
                windStatus,
                gustStatus,
                rainStatus,
                tempStatus,
                visibilityStatus,
                daylightStatus
            ];
            let overallStatus = 'safe';
            if (allStatuses.includes('danger')) {
                overallStatus = 'danger';
            } else if (allStatuses.includes('warning')) {
                overallStatus = 'warning';
            }

            const rainDescription = precipitation === 0 ? 'Aucune' : 
                                   precipitation < 2.5 ? 'L√©g√®re' : 'Forte';

            const html = `
                <div class="weather-grid">

                    <div class="weather-item ${windStatus}">
                        <div class="weather-label">üí® Vent en vol (10m)</div>
                        <div class="weather-value">${windSpeed.toFixed(1)} <span class="unit">km/h</span></div>
                    </div>

                    <div class="weather-item ${gustStatus}">
                        <div class="weather-label">üå¨Ô∏è Rafales max</div>
                        <div class="weather-value">${gusts.toFixed(0)} <span class="unit">km/h</span></div>
                    </div>

                    <div class="weather-item ${visibilityStatus}">
                        <div class="weather-label">üëÅÔ∏è Visibilit√©</div>
                        <div class="weather-value">${visibility.toFixed(1)} <span class="unit">km</span></div>
                    </div>

                    <div class="weather-item ${rainStatus}">
                        <div class="weather-label">üåßÔ∏è Pr√©cipitations</div>
                        <div class="weather-value">${rainDescription}</div>
                    </div>

                    <div class="weather-item ${tempStatus}">
                        <div class="weather-label">üå°Ô∏è Temp√©rature</div>
                        <div class="weather-value">${temp.toFixed(1)} <span class="unit">¬∞C</span></div>
                    </div>

                    <div class="weather-item ${daylightStatus}">
                        <div class="weather-label">üåÖ Luminosit√©</div>
                        <div class="weather-value">
                            ${isDaylight ? 'Jour' : 'Nuit'} :
                            ${now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}<br>
                            <div class="subtext">
                                ${sunrise.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                ‚Äì
                                ${sunset.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                            </div>
                        </div>
                    </div>

                </div>

                <div class="overall-status ${overallStatus}">
                    ${overallStatus === 'safe' ? '‚úÖ Conditions favorables au vol' : 
                    overallStatus === 'warning' ? '‚ö†Ô∏è Vol possible avec vigilance' : 
                    '‚ùå Vol d√©conseill√©'}
                </div>
            `;


            document.getElementById('weatherData').innerHTML = html;
            
            const statusIndicator = document.getElementById('weatherStatus');
            statusIndicator.className = 'status-indicator status-' + 
                (overallStatus === 'safe' ? 'green' : overallStatus === 'warning' ? 'orange' : 'red');
        }

        // Mode switch pour calculateur ND
        let currentMode = 'auto';
        
        function switchMode(mode) {
            currentMode = mode;
            const autoBtn = document.getElementById('autoModeBtn');
            const manualBtn = document.getElementById('manualModeBtn');
            const autoFields = document.getElementById('autoModeFields');
            const manualFields = document.getElementById('manualModeFields');

            if (mode === 'auto') {
                autoBtn.style.background = 'linear-gradient(135deg, var(--accent-cyan), var(--accent-green))';
                autoBtn.style.border = 'none';
                manualBtn.style.background = 'var(--bg-card)';
                manualBtn.style.border = '1px solid var(--border-color)';
                autoFields.style.display = 'block';
                manualFields.style.display = 'none';
            } else {
                manualBtn.style.background = 'linear-gradient(135deg, var(--accent-cyan), var(--accent-green))';
                manualBtn.style.border = 'none';
                autoBtn.style.background = 'var(--bg-card)';
                autoBtn.style.border = '1px solid var(--border-color)';
                autoFields.style.display = 'none';
                manualFields.style.display = 'block';
            }
        }

        // Calculateur de filtre ND - VERSION R√âALISTE
        function calculateNDFilter() {
            const fps = parseInt(document.getElementById('fps').value);
            const droneModel = document.getElementById('droneModel').value;
            
            // R√®gle des 180¬∞ : vitesse d'obturation cible = 1/(2 √ó fps)
            const targetShutterSpeed = 2 * fps;
            const shutterSpeedFraction = `1/${targetShutterSpeed}`;

            let currentShutterSpeed;
            let estimatedRange = '';

            if (currentMode === 'manual') {
                // Mode manuel : l'utilisateur entre sa vitesse actuelle
                const input = document.getElementById('currentShutter').value;
                if (!input || input <= 0) {
                    alert("Veuillez entrer une vitesse d'obturation valide (ex: 2000 pour 1/2000)");
                    return;
                }
                currentShutterSpeed = parseInt(input);
            } else {
                // Mode auto : estimation bas√©e sur les conditions lumineuses
                const lightCondition = document.getElementById('lightCondition').value;
                
                // Estimations r√©alistes de vitesse d'obturation sans filtre
                switch(lightCondition) {
                    case 'overcast':
                        currentShutterSpeed = 750; // ~1/500 √† 1/1000
                        estimatedRange = '(estimation: 1/500 - 1/1000)';
                        break;
                    case 'partlyCloudy':
                        currentShutterSpeed = 1500; // ~1/1000 √† 1/2000
                        estimatedRange = '(estimation: 1/1000 - 1/2000)';
                        break;
                    case 'sunny':
                        currentShutterSpeed = 3000; // ~1/2000 √† 1/4000
                        estimatedRange = '(estimation: 1/2000 - 1/4000)';
                        break;
                    case 'verySunny':
                        currentShutterSpeed = 6000; // ~1/4000 √† 1/8000
                        estimatedRange = '(estimation: 1/4000 - 1/8000)';
                        break;
                }

                // Ajustement GoPro (capteur plus sensible)
                if (droneModel === 'gopro12') {
                    currentShutterSpeed = Math.round(currentShutterSpeed * 1.3);
                }
            }

            // CALCUL EXACT selon l'article : current √∑ target = facteur ND n√©cessaire
            const ndFactorNeeded = currentShutterSpeed / targetShutterSpeed;

            // Gamme compl√®te de filtres ND disponibles
            const availableFilters = [
                { name: 'ND4', factor: 4, stops: 2, usage: 'L√©g√®re r√©duction, jours nuageux' },
                { name: 'ND8', factor: 8, stops: 3, usage: 'Nuageux lumineux, int√©rieur lumineux' },
                { name: 'ND16', factor: 16, stops: 4, usage: 'Ensoleill√© mod√©r√©, vid√©o standard' },
                { name: 'ND32', factor: 32, stops: 5, usage: 'Plein soleil, protection standard' },
                { name: 'ND64', factor: 64, stops: 6, usage: 'Tr√®s ensoleill√©, r√©flexions eau/neige' },
                { name: 'ND128', factor: 128, stops: 7, usage: 'Soleil intense + surfaces r√©fl√©chissantes' },
                { name: 'ND256', factor: 256, stops: 8, usage: 'Conditions extr√™mes' },
                { name: 'ND512', factor: 512, stops: 9, usage: 'Hyperlapses, neige √©clatante' }
            ];

            // Trouver le filtre le plus proche du facteur calcul√©
            let bestFilter = availableFilters[0];
            let secondBestFilter = availableFilters[0];
            let minDiff = Math.abs(availableFilters[0].factor - ndFactorNeeded);

            for (let i = 0; i < availableFilters.length; i++) {
                const diff = Math.abs(availableFilters[i].factor - ndFactorNeeded);
                if (diff < minDiff) {
                    minDiff = diff;
                    secondBestFilter = bestFilter;
                    bestFilter = availableFilters[i];
                } else if (i > 0 && availableFilters[i].factor > bestFilter.factor) {
                    secondBestFilter = availableFilters[i];
                    break;
                }
            }

            // Si le facteur n√©cessaire est entre deux filtres, proposer les deux
            if (bestFilter.factor < ndFactorNeeded && secondBestFilter.factor > bestFilter.factor) {
                // Le facteur n√©cessaire est entre deux filtres
            } else if (bestFilter.factor > ndFactorNeeded) {
                // Le meilleur filtre est d√©j√† trop fort, proposer aussi un plus faible
                const index = availableFilters.indexOf(bestFilter);
                if (index > 0) {
                    secondBestFilter = availableFilters[index - 1];
                }
            } else {
                // Le meilleur filtre est trop faible, proposer un plus fort
                const index = availableFilters.indexOf(bestFilter);
                if (index < availableFilters.length - 1) {
                    secondBestFilter = availableFilters[index + 1];
                }
            }

            const html = `
                <div class="filter-result">
                    <h3 style="color: var(--accent-cyan); margin-bottom: 15px; font-family: 'Inconsolata', monospace;">
                        RECOMMANDATIONS
                    </h3>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: rgba(6, 182, 212, 0.1); border-radius: 8px; border-left: 4px solid var(--accent-cyan);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <div>
                                <div style="color: var(--text-secondary); font-size: 0.9rem;">Vitesse cible (r√®gle 180¬∞)</div>
                                <div class="shutter-speed">${shutterSpeedFraction}s</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: var(--text-secondary); font-size: 0.9rem;">Vitesse actuelle ${estimatedRange}</div>
                                <div class="shutter-speed">1/${currentShutterSpeed}s</div>
                            </div>
                        </div>
                        <div style="padding-top: 10px; border-top: 1px solid var(--border-color);">
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Facteur ND n√©cessaire</div>
                            <div style="font-size: 1.4rem; font-weight: 700; color: var(--accent-green); font-family: 'Inconsolata', monospace;">
                                ND${Math.round(ndFactorNeeded)} (${ndFactorNeeded.toFixed(1)} calcul√©)
                            </div>
                        </div>
                    </div>

                    <div class="filter-recommendation" style="border-left-color: var(--accent-green); background: linear-gradient(90deg, rgba(16, 185, 129, 0.15), transparent);">
                        <div>
                            <div class="filter-name" style="color: var(--accent-green);">
                                üéØ #1 - Filtre ${bestFilter.name}
                            </div>
                            <div class="filter-details">${bestFilter.usage}</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">
                                ${bestFilter.factor < ndFactorNeeded ? 
                                    '‚ö†Ô∏è L√©g√®rement sous-expos√©, ajuster ISO ou diaphragme' : 
                                    bestFilter.factor > ndFactorNeeded ?
                                    'üí° L√©g√®rement sur-expos√©, fermer diaphragme' :
                                    '‚úÖ Exposition parfaite'}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">R√©duction</div>
                            <div style="font-weight: 600; color: var(--accent-green); font-size: 1.2rem;">${bestFilter.stops} stops</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 3px;">Facteur ${bestFilter.factor}</div>
                        </div>
                    </div>

                    <div class="filter-recommendation">
                        <div>
                            <div class="filter-name">#2 - Filtre ${secondBestFilter.name}</div>
                            <div class="filter-details">${secondBestFilter.usage}</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">
                                Alternative si conditions variables
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">R√©duction</div>
                            <div style="font-weight: 600; color: var(--accent-cyan); font-size: 1.2rem;">${secondBestFilter.stops} stops</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 3px;">Facteur ${secondBestFilter.factor}</div>
                        </div>
                    </div>

                    ${currentMode === 'auto' ? `
                        <div style="margin-top: 15px; padding: 12px; background: rgba(245, 158, 11, 0.1); border-radius: 8px; border-left: 4px solid var(--accent-orange);">
                            <div style="font-size: 0.9rem; color: var(--text-secondary);">
                                ‚ö° Mode automatique : Pour un calcul pr√©cis, passez en mode MANUEL et entrez votre vitesse d'obturation actuelle affich√©e sur la cam√©ra (sans filtre).
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('filterResult').innerHTML = html;
        }


        function getDroneMapByCountry(countryCode, countryName = "") {

            const droneMaps = {

                // üá™üá∫ EUROPE
                BE: "https://map.droneguide.be/",
                AT: "https://utm.dronespace.at/avm/",
                CZ: "https://dronemap.gov.cz/",
                DK: "https://www.en.droneregler.dk/uas-geographical-zones",
                EE: "https://utm.eans.ee/avm/",
                IE: "https://www.iaa.ie/general-aviation/drones/uas-geographic-zones",
                IT: "https://www.d-flight.it/web-app/",
                LV: "https://www.airspace.lv/drones",
                LT: "https://utm.ans.lt/avm/",
                NL: "https://map.godrone.nl/",
                PL: "https://dronemap.pansa.pl/",
                RO: "https://flightplan.romatsa.ro/init/drones",
                SE: "https://daim.lfv.se/echarts/dronechart/",
                CH: "https://map.geo.admin.ch/",
                DE: "https://maptool-dipul.dfs.de/?language=en&zoom=10.7",
                ES: "", // Espagne (√† compl√©ter plus tard)
                GB: "", // Royaume-Uni (√† compl√©ter plus tard)


                // üåé AUTRES
                US: "https://faa.maps.arcgis.com/apps/webappviewer/index.html?id=9c2e4406710048b59bca7c8e8b9a02b3",
                CA: "https://nrc.canada.ca/en/drone-tool/",
                AU: "https://dronecompliance.casa.gov.au/map",
                NZ: "https://www.airshare.co.nz/maps",
                BR: "https://www.decea.mil.br/drone",
                JP: "https://www.mlit.go.jp/koku/drone/en/"
            };

            const container = document.getElementById("droneMapLinkContainer");

            // üîÅ Toujours vider avant d'afficher
            container.innerHTML = "";

            // üá´üá∑ Si France ‚Üí ne rien afficher
            if (countryCode === "FR") {
                return;
            }

            if (countryCode in droneMaps) {
                const flag = getFlagEmoji(countryCode);

                container.innerHTML = `
                    <div style="margin-bottom:15px; padding:15px; 
                                background:rgba(245,158,11,0.1);
                                border-left:4px solid var(--accent-orange);
                                border-radius:8px;">
                        üåç Restrictions drone officielles d√©tect√©es pour 
                        <strong>${countryName || countryCode}</strong><br><br>
                        <button 
                            ${droneMaps[countryCode] ? 
                                `onclick="window.open('${droneMaps[countryCode]}','_blank')"` 
                                : 'disabled'}
                            style="padding:10px 15px; ${!droneMaps[countryCode] ? 'opacity:0.5; cursor:not-allowed;' : ''}">
                            üîé Voir la carte officielle ${flag}
                        </button>

                    </div>
                `;
            }
        }

        function getFlagEmoji(countryCode) {
            if (!countryCode || countryCode.length !== 2) return "";

            return countryCode
                .toUpperCase()
                .replace(/./g, char => 
                    String.fromCodePoint(127397 + char.charCodeAt())
                );
        }



        // Initialisation au chargement
        window.onload = function() {
            initMap(); // carte par d√©faut (Paris)

        };
    </script>
</body>
</html>